trigger:
- main
 
stages:
# =========================
# CI - BUILD (Self-hosted)
# =========================
- stage: Build
  displayName: "CI - Build Grupo 3 (Self-hosted)"
  jobs:
  - job: BuildJob
    displayName: "Build artifact en VM"
    pool:
      name: "Default"  
    steps:
      - checkout: self
 
      - script: |
          rm -rf dist
          mkdir -p dist
          echo "<h1>✅ Deploy OK - DevOps Grupo 3</h1>" > dist/index.html
          echo "<p>Environment: env-grupo03-vm</p>" >> dist/index.html
          echo "<p>VM: vm-linux-1</p>" >> dist/index.html
          echo "<p>CD usando Azure Pipelines Environments (sin ARM Service Connection)</p>" >> dist/index.html
        displayName: "Generar artefacto"
 
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "dist"
          artifact: "drop"
        displayName: "Publicar artefacto"
 
 
# =========================
# CD - DEPLOY (Environment)
# =========================
- stage: Deploy
  displayName: "CD - Deploy a VM (Environment)"
  dependsOn: Build
  jobs:
  - deployment: DeployToVM
    displayName: "Deploy a vm-linux-1"
    environment:
      name: "env-grupo03-vm"
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
            - download: current
              artifact: drop
              displayName: "Descargar artefacto"
 
            - script: |
                sudo apt update
                sudo apt install -y apache2
                sudo systemctl enable apache2
                sudo systemctl start apache2
              displayName: "Instalar y levantar Apache"
 
            - script: |
                sudo rm -rf /var/www/html/*
                sudo cp -r $(Pipeline.Workspace)/drop/* /var/www/html/
                sudo chmod -R 755 /var/www/html
              displayName: "Deploy a /var/www/html"
 
            - script: |
                echo "✅ Deploy completado"
                curl -I http://localhost || true
              displayName: "Verificación"
